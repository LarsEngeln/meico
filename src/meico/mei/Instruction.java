package meico.mei;

import nu.xom.Element;
import nu.xom.ParentNode;

import java.util.ArrayList;

/**
 * This class represents an ornaments instruction by managing the notes to played for the very ornament.
 * @author Lars Engeln
 */
public class Instruction {
    private MeiElement instructionElement;
    private MeiElement groupElement;
    private ArrayList<MeiElement> notes;

    private ArrayList<MeiElement> correspondences;

    public Instruction() {
        instructionElement          = new MeiElement("supplied");
        groupElement                = new MeiElement("graceGrp");
        notes                       = new ArrayList<>();
        correspondences             = new ArrayList<>();

        instructionElement.appendChild(groupElement);

        instructionElement.set("evidence", "internal");
        instructionElement.set("reason", "generated by meico to give a basic instruction for the ornament's notes");
    }

    public void setLabel(String label) {
        instructionElement.set("label", label);
        groupElement.set("label", label);
    }

    public void addCorrespondence(MeiElement note) {
        correspondences.add(note);
        String corresp = "";
        boolean isFirst = true;
        for (MeiElement c : correspondences) {
            String id = Helper.getAttribute("id", c.getElement()).getValue();
            if (!isFirst) corresp += ' ';
            else isFirst = false;
            corresp += '#' + id;
        };

        instructionElement.set("corresp", corresp);
    }

    public void addElement(MeiElement element) {
        if(element.getName().equals("note")) {
            element.set("stem.visible", "false");
            notes.add(element);
        }
        groupElement.appendChild(element);
    }
    public MeiElement getNote(int index) { return notes.get(index); }
    public ArrayList<MeiElement> getNotes() { return notes; }

    public void removeNote(int index) {
        notes.remove(index);
        groupElement.getElement().removeChild(index);
    }

    public Element getInstructionElement() {
        return instructionElement.getElement();
    }

    public MeiElement getGroupElement() {
        return groupElement;
    }

    public void append(Instruction instruction) {
        MeiElement lastNote = getNote(notes.size()-1);
        MeiElement firstNote = getNote(0);

        if(lastNote.get("pname").equals(firstNote.get("pname"))
                && lastNote.get("accid.ges").equals(firstNote.get("accid.ges"))) {
            instruction.removeNote(0);
        }

        MeiElement child = instruction.getGroupElement();
        ParentNode parent = child.getElement().getParent();
        if (parent != null) {
            parent.removeChild(child.getElement());
        }
        this.instructionElement.appendChild(child);
        instructionElement.set("label", instructionElement.get("label") + ", " + child.get("label"));
    }
}
